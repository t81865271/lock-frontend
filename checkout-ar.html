<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout - Lock Perfume</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Your exact styles here... (unchanged) */
    body { margin: 0; font-family: 'Lato', sans-serif; background: url('images/background.jpg') no-repeat center center fixed; background-size: cover; color: #333; }
    .checkout-container { background-color: rgba(255, 255, 255, 0.95); padding: 20px; max-width: 600px; margin: 0 auto; border-radius: 12px; }
    .header { display: flex; align-items: center; justify-content: space-between; padding: 20px 0; position: relative; }
    .return-arrow { font-size: 24px; cursor: pointer; position: absolute; left: 10px; }
    .logo { height: 50px; margin: 0 auto; }
    h3 { font-weight: 600; margin-top: 30px; margin-bottom: 15px; }
    .items-summary { border-top: 1px solid #ddd; padding-top: 20px; }
    .checkout-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 15px 0; }
    .checkout-item img { width: 60px; height: 60px; object-fit: cover; border-radius: 8px; }
    .checkout-item-details { flex: 1; margin-left: 15px; }
    .checkout-item-details h4 { margin: 0; font-weight: 500; }
    .checkout-item-price { font-weight: 600; color: #888; }
    .promo-section input, .customer-info input, .address-info input, .address-info select { width: 100%; padding: 12px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 20px; box-sizing: border-box; }
    .promo-section button, .pay-now-section button { width: 100%; padding: 15px; background-color: #000; color: #fff; border-radius: 8px; border: none; cursor: pointer; font-size: 16px; transition: all 0.3s ease; }
    .promo-section button:hover, .pay-now-section button:hover { box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2); }
    .total-summary { margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; }
    .total { font-weight: 700; font-size: 18px; }
    .error-message { color: red; font-size: 14px; margin-bottom: 10px; min-height: 20px; }
    #promo-message { color: red; font-size: 14px; margin-top: 10px; }
    #discount-row { display: none; }
  </style>
</head>
<body>

<header class="header">
  <div class="return-arrow" onclick="goBack()">‚Üê</div>
  <img src="images/logo.png" alt="Lock Perfume Logo" class="logo" />
</header>

<div class="checkout-container">

  <h3>Items</h3>
  <section class="items-summary" id="checkout-items"></section>

  <h3>Promo Code</h3>
  <section class="promo-section">
    <input type="text" id="promo-code" placeholder="Enter promo code">
    <button onclick="applyPromo()">Apply</button>
    <div id="promo-message" class="promo-success"></div>
  </section>

  <h3>Customer Info</h3>
  <section class="customer-info">
    <div id="first-name-error" class="error-message"></div>
    <input type="text" id="first-name" placeholder="First Name" required />

    <div id="last-name-error" class="error-message"></div>
    <input type="text" id="last-name" placeholder="Last Name" required />

    <div id="phone-error" class="error-message"></div>
    <input type="tel" id="phone-number" placeholder="Phone Number" required />

    <div id="email-error" class="error-message"></div>
    <input type="email" id="email" placeholder="Email" required />
  </section>

  <h3>Address Info</h3>
  <section class="address-info">
    <div id="area-error" class="error-message"></div>
    <select id="area" onchange="updateDeliveryFee()" required>
      <option value="">Select Area</option>
      <option value="Asimah">Abdullah Al-Salem</option>
      <option value="Asimah">Rawda</option>
      <option value="Hawalli">Qurtuba</option>
      <option value="Ahmadi">Egaila</option>
      <option value="Farwaniya">Khaitan</option>
      <option value="Jahra">Waha</option>
    </select>

    <div id="block-error" class="error-message"></div>
    <input type="text" id="block" placeholder="Block" required />

    <div id="street-error" class="error-message"></div>
    <input type="text" id="street" placeholder="Street" required />

    <input type="text" id="jadda" placeholder="Jadda" />
    <div id="house-error" class="error-message"></div>
    <input type="text" id="house" placeholder="House Number" required />

    <input type="text" id="building" placeholder="Building" />
    <input type="text" id="floor" placeholder="Floor" />
    <input type="text" id="apartment" placeholder="Apartment" />
  </section>

  <h3>Summary</h3>
  <section class="total-summary">
    <div class="summary-row"><span>Subtotal</span><span id="subtotal">0.000 KWD</span></div>
    <div class="summary-row"><span>Delivery Fee</span><span id="delivery-fee">0.000 KWD</span></div>
    <div class="summary-row" id="discount-row"><span>Discount</span><span id="discount">0.000 KWD</span></div>
    <div class="summary-row total"><span>Total</span><span id="total">0.000 KWD</span></div>
  </section>

  <div class="pay-now-section">
    <button onclick="payNow()">Pay Now</button>
  </div>

</div>

<script>

// Generate or get existing userID
let userID = localStorage.getItem('userID');
if (!userID) {
  userID = 'USER-' + Date.now() + '-' + Math.floor(Math.random() * 1000000);
  localStorage.setItem('userID', userID);
}

  const promoCodes = { "lock10": 10, "lock20": 20 };
  let cart = JSON.parse(localStorage.getItem('cart')) || [];
  let discountPercentage = 0;
  let deliveryFee = 0;

  const scriptURL = 'https://script.google.com/macros/s/AKfycbwnTJNaTqrzIbXorBJZr3pwbAJh98i28ktL6Ad2UAoAjW-99z-Fxh6rOgZ5kOTMdk0k/exec';  // << Replace this with your deployed web app URL

  function displayCheckoutItems() {
    const container = document.getElementById('checkout-items');
    container.innerHTML = '';
    if (cart.length === 0) {
      container.innerHTML = '<p>Your cart is empty.</p>';
      return;
    }
    cart.forEach(item => {
      const itemRow = document.createElement('div');
      itemRow.className = 'checkout-item';
      const imageName = item.name.toLowerCase().replace(/ /g, '') + '.jpg';
      itemRow.innerHTML = `
        <img src="images/${imageName}" alt="${item.name}" />
        <div class="checkout-item-details"><h4>${item.name}</h4></div>
        <div class="checkout-item-price">${(item.price * item.quantity).toFixed(3)} KWD</div>`;
      container.appendChild(itemRow);
    });
    updateTotalSummary();
  }

  function updateDeliveryFee() {
    const governorate = document.getElementById('area').value;
    deliveryFee = (governorate === "Asimah" || governorate === "Hawalli" || governorate === "Farwaniya") ? 1 : 2;
    document.getElementById('delivery-fee').innerText = deliveryFee.toFixed(3) + ' KWD';
    updateTotalSummary();
    sendDataToSheet("UNPAID");
  }

  function updateTotalSummary() {
    const subtotal = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
    const discount = (discountPercentage / 100) * subtotal;
    const total = subtotal + deliveryFee - discount;
    document.getElementById('subtotal').innerText = subtotal.toFixed(3) + ' KWD';
    document.getElementById('total').innerText = total.toFixed(3) + ' KWD';
    const discountRow = document.getElementById('discount-row');
    if (discountPercentage > 0) {
      discountRow.style.display = 'flex';
      document.getElementById('discount').innerText = '-' + discount.toFixed(3) + ' KWD';
    } else {
      discountRow.style.display = 'none';
    }
  }

  function applyPromo() {
    const promoCodeInput = document.getElementById('promo-code').value.trim().toLowerCase();
    const promoMessage = document.getElementById('promo-message');
    if (promoCodes[promoCodeInput]) {
      discountPercentage = promoCodes[promoCodeInput];
      promoMessage.innerText = `-${discountPercentage}% discount applied!`;
    } else {
      discountPercentage = 0;
      promoMessage.innerText = 'Invalid promo code.';
    }
    updateTotalSummary();
  }

  function payNow() {
    const firstName = document.getElementById('first-name').value.trim();
    const lastName = document.getElementById('last-name').value.trim();
    const phoneNumber = document.getElementById('phone-number').value.trim();
    const email = document.getElementById('email').value.trim();
    const area = document.getElementById('area').value.trim();
    const block = document.getElementById('block').value.trim();
    const street = document.getElementById('street').value.trim();
    const house = document.getElementById('house').value.trim();

    document.getElementById('first-name-error').innerText = firstName === '' ? 'Please enter first name.' : '';
    document.getElementById('last-name-error').innerText = lastName === '' ? 'Please enter last name.' : '';
    document.getElementById('phone-error').innerText = (phoneNumber.length !== 8 || isNaN(phoneNumber)) ? 'Invalid phone number.' : '';
    document.getElementById('email-error').innerText = (!email.includes('@')) ? 'Invalid email address.' : '';
    document.getElementById('area-error').innerText = area === '' ? 'Please enter an area.' : '';
    document.getElementById('block-error').innerText = block === '' ? 'Please enter a block.' : '';
    document.getElementById('street-error').innerText = street === '' ? 'Please enter a street.' : '';
    document.getElementById('house-error').innerText = house === '' ? 'Please enter a house number.' : '';

    const errors = document.querySelectorAll('.error-message');
    for (let err of errors) {
      if (err.innerText !== '') return;
    }

    sendDataToSheet("UNPAID"); // still unpaid until payment is confirmed
    alert('Ready to integrate with MyFatoorah!');
  }

  function goBack() {
    window.location.href = "index.html";
  }

  function sendDataToSheet(status = "UNPAID") {
  const firstName = document.getElementById('first-name').value.trim();
  const lastName = document.getElementById('last-name').value.trim();
  const phoneNumber = document.getElementById('phone-number').value.trim();
  const email = document.getElementById('email').value.trim();
  const area = document.getElementById('area').value.trim();
  const block = document.getElementById('block').value.trim();
  const street = document.getElementById('street').value.trim();
  const house = document.getElementById('house').value.trim();
  const building = document.getElementById('building').value.trim();
  const floor = document.getElementById('floor').value.trim();
  const apartment = document.getElementById('apartment').value.trim();

  const formData = {
    UserID: userID,           // This is important for updating the same row
    FirstName: firstName,
    LastName: lastName,
    PhoneNumber: phoneNumber,
    Email: email,
    Area: area,
    Block: block,
    Street: street,
    House: house,
    Building: building,
    Floor: floor,
    Apartment: apartment,
    Status: status
  };
  
  fetch('https://script.google.com/macros/s/AKfycbwJp_CPE-7NDjz78IEAhD1AOBo__En2GeGQHB5hOikTn4qqeDm73TkQL6kZx1AJDcD_/exec', {
    method: 'POST',
    mode: 'no-cors',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(formData)
  })
  .then(() => console.log('Data sent to Google Sheet'))
  .catch(error => console.error('Error!', error.message));
}

// Automatically send data when a user leaves a field (input/select)
document.querySelectorAll('input, select').forEach(el => {
  el.addEventListener('blur', () => sendDataToSheet("UNPAID"));
});

  const trackedFields = [
  'first-name',
  'last-name',
  'phone-number',
  'email',
  'area',
  'block',
  'street',
  'jadda',
  'house',
  'building',
  'floor',
  'apartment'
];

trackedFields.forEach(id => {
  const field = document.getElementById(id);
  if (field) {
    field.addEventListener('blur', () => {
      sendDataToSheet("UNPAID");
    });
  }
});

  displayCheckoutItems();

</script>
<script src="script.js"></script>
</body>
</html>